<script>
function processTranscript() {
  console.clear();
  console.log("התחלת עיבוד...");

  const transcript = document.getElementById("transcript").value.trim();
  const speakers = document.getElementById("speakers").value.trim();

  if (!transcript || !speakers) {
    document.getElementById("output").textContent = "אנא הכנס גם תמלול וגם מידע על הדוברים.";
    console.error("אחד או שני השדות ריקים!");
    return;
  }

  console.log("תמלול שהוזן:");
  console.log(transcript);

  console.log("מידע על הדוברים שהוזן:");
  console.log(speakers);

  // עיבוד המידע על הדוברים
  const speakerEntries = speakers.split('\n').map(line => {
    const match = line.match(/\[\s*(.*?)\s*-->\s*(.*?)\]\s+(.*?)\s+(SPEAKER_\d+)/);
    if (match) {
      return {
        start: match[1],
        end: match[2],
        speaker: match[4]
      };
    }
    return null;
  }).filter(Boolean);

  console.log("רשימת הדוברים לאחר עיבוד:");
  console.log(speakerEntries);

  // עיבוד התמלול
  const transcriptLines = transcript.split('\n').map(line => {
    const match = line.match(/^\d+\s+(\d{2}:\d{2}:\d{2},\d{3}) --> (\d{2}:\d{2}:\d{2},\d{3})\s+(.*)/);
    if (match) {
      return {
        start: match[1],
        end: match[2],
        text: match[3]
      };
    }
    return null;
  }).filter(Boolean);

  if (transcriptLines.length === 0) {
    console.error("לא נמצאו שורות תמלול. בדוק את הפורמט.");
    document.getElementById("output").textContent = "שגיאה בעיבוד התמלול. בדוק את הפורמט.";
    return;
  }

  console.log("שורות התמלול לאחר עיבוד:");
  console.log(transcriptLines);

  // הפיכת הרשימות כך שהבדיקה תהיה מהסוף להתחלה
  speakerEntries.reverse();
  transcriptLines.reverse();

  // שילוב המידע על הדוברים עם התמלול
  let output = '';
  transcriptLines.forEach(line => {
    const speaker = speakerEntries.find(
      s => line.start <= s.end && line.end >= s.start
    );
    const speakerLabel = speaker ? speaker.speaker : 'דובר לא ידוע';
    output = `${speakerLabel}: ${line.text}\n` + output;
    console.log(`שורה מעובדת: ${line.text}`);
    console.log(`דובר: ${speakerLabel}`);
  });

  console.log("תוצאה סופית:");
  console.log(output);

  // הצגת התוצאה
  document.getElementById("output").textContent = output;
}
</script>
